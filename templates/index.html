<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f1923; color: #e0e0e0; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, #1a2a3a, #0d2137);
            padding: 20px 32px; border-bottom: 1px solid #1e3a5f;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 22px; color: #4fc3f7; }
        .header p { font-size: 13px; color: #78909c; margin-top: 4px; }

        .container { max-width: 960px; margin: 0 auto; padding: 24px; }

        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input {
            width: 100%; padding: 14px 18px; font-size: 15px;
            background: #1a2a3a; border: 1px solid #2a3f55; border-radius: 8px;
            color: #fff; outline: none; transition: border-color 0.2s;
        }
        .search-box input:focus { border-color: #4fc3f7; }
        .search-box input::placeholder { color: #546e7a; }

        .dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1a2a3a; border: 1px solid #2a3f55; border-top: none;
            border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto;
            z-index: 100; display: none;
        }
        .dropdown.show { display: block; }
        .dropdown-item {
            padding: 10px 18px; cursor: pointer; font-size: 14px;
            border-bottom: 1px solid #162636; display: flex; justify-content: space-between;
        }
        .dropdown-item:hover { background: #243b53; }
        .dropdown-item .num { color: #546e7a; font-size: 12px; }

        .selected-stock {
            display: none; background: #1a2a3a; border: 1px solid #2a3f55;
            border-radius: 8px; padding: 16px 20px; margin-bottom: 16px;
            align-items: center; justify-content: space-between;
        }
        .selected-stock.show { display: flex; }
        .selected-stock .info .name { font-size: 17px; font-weight: 600; color: #fff; }
        .selected-stock .info .url { font-size: 12px; color: #546e7a; margin-top: 4px; }

        .btn {
            padding: 10px 28px; font-size: 14px; font-weight: 600;
            border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: #4fc3f7; color: #0f1923; }
        .btn-primary:hover { background: #81d4fa; }
        .btn-primary:disabled { background: #37474f; color: #78909c; cursor: not-allowed; }
        .btn-outline { background: none; border: 1px solid #2a3f55; color: #90a4ae; padding: 8px 16px; font-size: 13px; }
        .btn-outline:hover { border-color: #4fc3f7; color: #4fc3f7; }
        .btn-clear { background: none; border: 1px solid #37474f; color: #78909c; padding: 6px 14px; font-size: 12px; margin-left: 12px; }
        .btn-clear:hover { border-color: #ef5350; color: #ef5350; }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading.show { display: block; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #2a3f55;
            border-top-color: #4fc3f7; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .result-card {
            display: none; background: #1a2a3a; border-radius: 10px;
            border: 1px solid #2a3f55; overflow: hidden; margin-top: 20px;
        }
        .result-card.show { display: block; }
        .result-card .result-header {
            padding: 16px 20px; background: #162636;
            display: flex; justify-content: space-between; align-items: center;
        }
        .result-card .result-header h3 { font-size: 15px; color: #90a4ae; }
        .result-card .result-header .date { font-size: 12px; color: #546e7a; }
        .result-body { padding: 24px; text-align: center; }
        .result-value { font-size: 36px; font-weight: 700; margin: 12px 0; }
        .result-value.buy { color: #ef5350; }
        .result-value.sell { color: #42a5f5; }
        .result-value.neutral { color: #ffa726; }
        .result-value.error { color: #78909c; }
        .result-stock-name { font-size: 18px; color: #b0bec5; margin-bottom: 8px; }

        .history { margin-top: 32px; }
        .history-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; border-bottom: 1px solid #1e3a5f; padding-bottom: 8px;
        }
        .history-header h3 { font-size: 15px; color: #546e7a; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { text-align: left; padding: 10px 14px; font-size: 12px; color: #546e7a; background: #162636; font-weight: 500; }
        .history-table td { padding: 10px 14px; font-size: 14px; border-bottom: 1px solid #162636; }
        .history-table tr:hover td { background: #1e3044; }

        .tag { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .tag-buy { background: rgba(239,83,80,0.15); color: #ef5350; }
        .tag-sell { background: rgba(66,165,245,0.15); color: #42a5f5; }
        .tag-neutral { background: rgba(255,167,38,0.15); color: #ffa726; }
        .tag-error { background: rgba(120,144,156,0.15); color: #78909c; }

        .empty-state { text-align: center; padding: 60px 20px; color: #37474f; }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        .toast {
            position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
            border-radius: 8px; font-size: 14px; z-index: 300; color: #fff;
            transform: translateY(80px); opacity: 0; transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Stock Analyzer</h1>
            <p>Investing.com ProPicks 분석 결과 조회</p>
        </div>
        <div>
            <button class="btn btn-outline" onclick="exportExcel()" id="exportBtn" style="display:none;">Excel 내보내기</button>
        </div>
    </div>

    <div class="container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="종목명을 입력하세요 (예: 삼성전자, SK하이닉스...)" autocomplete="off">
            <div class="dropdown" id="dropdown"></div>
        </div>

        <div class="selected-stock" id="selectedStock">
            <div class="info">
                <div class="name" id="stockName"></div>
                <div class="url" id="stockUrl"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyze()">분석 조회</button>
                <button class="btn btn-clear" onclick="clearSelection()">취소</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">분석 결과를 가져오는 중... (약 10~20초 소요)</p>
        </div>

        <div class="result-card" id="resultCard">
            <div class="result-header">
                <h3>분석 결과</h3>
                <span class="date" id="resultDate"></span>
            </div>
            <div class="result-body">
                <div class="result-stock-name" id="resultName"></div>
                <div class="result-value" id="resultValue"></div>
            </div>
        </div>

        <div class="history" id="historySection" style="display:none;">
            <div class="history-header">
                <h3>조회 기록 (<span id="historyCount">0</span>건)</h3>
                <button class="btn btn-outline" onclick="exportExcel()">Excel 저장</button>
            </div>
            <table class="history-table">
                <thead><tr><th>#</th><th>순번</th><th>종목</th><th>분석 결과</th><th>조회 시간</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState">
            <div class="icon">&#128200;</div>
            <p>종목을 검색하고 "분석 조회" 버튼을 클릭하면<br>자동으로 분석 결과를 가져옵니다.</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const stocks = {{ stocks | tojson }};
        let selected = null;
        let history = [];

        const searchInput = document.getElementById('searchInput');
        const dropdown = document.getElementById('dropdown');

        searchInput.addEventListener('input', function() {
            const q = this.value.trim().toLowerCase();
            if (q.length === 0) { dropdown.classList.remove('show'); return; }
            const filtered = stocks.filter(s =>
                s['종목'].toLowerCase().includes(q) || String(s['순번']).includes(q)
            ).slice(0, 20);
            if (filtered.length === 0) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = filtered.map(s =>
                `<div class="dropdown-item" onclick='selectStock(${JSON.stringify(s).replace(/'/g,"&#39;")})'>
                    <span>${s['종목']}</span><span class="num">#${s['순번']}</span>
                </div>`
            ).join('');
            dropdown.classList.add('show');
        });

        searchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const first = dropdown.querySelector('.dropdown-item');
                if (first) first.click();
            }
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) dropdown.classList.remove('show');
        });

        function selectStock(stock) {
            selected = stock;
            searchInput.value = stock['종목'];
            dropdown.classList.remove('show');
            document.getElementById('stockName').textContent = stock['종목'];
            document.getElementById('stockUrl').textContent = stock['url'];
            document.getElementById('selectedStock').classList.add('show');
            document.getElementById('emptyState').style.display = 'none';
        }

        function clearSelection() {
            selected = null;
            searchInput.value = '';
            document.getElementById('selectedStock').classList.remove('show');
            document.getElementById('resultCard').classList.remove('show');
            if (history.length === 0) document.getElementById('emptyState').style.display = '';
        }

        function getResultClass(text) {
            if (!text) return 'error';
            if (text.includes('매수')) return 'buy';
            if (text.includes('매도')) return 'sell';
            if (text.includes('중립')) return 'neutral';
            return 'neutral';
        }

        function getTagClass(text) { return 'tag tag-' + getResultClass(text); }

        async function analyze() {
            if (!selected) return;
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultCard').classList.remove('show');

            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: selected['url'],
                        name: selected['종목'],
                        '순번': selected['순번']
                    })
                });
                const data = await res.json();

                if (data.error) {
                    showResult(selected['종목'], '오류: ' + data.error, '');
                    showToast(data.error, true);
                } else {
                    showResult(data.name, data.result, data.date);
                    history.unshift({ '순번': selected['순번'], '종목': data.name, '분석결과': data.result, date: data.date });
                    renderHistory();
                    showToast(`${data.name}: ${data.result}`);

                    // 다음 종목 자동 선택
                    const curIdx = stocks.findIndex(s => s['순번'] === selected['순번']);
                    if (curIdx >= 0 && curIdx + 1 < stocks.length) {
                        selectStock(stocks[curIdx + 1]);
                    }
                }
            } catch (e) {
                showResult(selected['종목'], '네트워크 오류', '');
                showToast('네트워크 오류 발생', true);
            } finally {
                btn.disabled = false;
                document.getElementById('loading').classList.remove('show');
            }
        }

        function showResult(name, value, date) {
            document.getElementById('resultName').textContent = name;
            const el = document.getElementById('resultValue');
            el.textContent = value;
            el.className = 'result-value ' + getResultClass(value);
            document.getElementById('resultDate').textContent = date;
            document.getElementById('resultCard').classList.add('show');
        }

        function renderHistory() {
            if (history.length === 0) return;
            document.getElementById('historySection').style.display = '';
            document.getElementById('historyCount').textContent = history.length;
            document.getElementById('exportBtn').style.display = '';
            document.getElementById('historyBody').innerHTML = history.map((h, i) =>
                `<tr>
                    <td>${history.length - i}</td>
                    <td>${h['순번']}</td>
                    <td>${h['종목']}</td>
                    <td><span class="${getTagClass(h['분석결과'])}">${h['분석결과']}</span></td>
                    <td>${h.date}</td>
                </tr>`
            ).join('');
        }

        async function exportExcel() {
            try {
                const res = await fetch('/api/export');
                const data = await res.json();
                if (data.ok) showToast(`${data.count}건 저장: ${data.path}`);
                else showToast(data.error, true);
            } catch (e) { showToast('내보내기 실패', true); }
        }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = isError ? '#c62828' : '#2e7d32';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
