# ğŸ¤– LLM ë‰´ìŠ¤ ë¶„ì„ ì‹œìŠ¤í…œ (Perplexity + Gemini)

> **ì†ŒìŠ¤ íŒŒì¼**: `kr_market/engine/llm_analyzer.py`  
> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-01-23  
> **ë²„ì „**: v2.0

---

## ğŸ“Š ë¶„ì„ íŒŒì´í”„ë¼ì¸ Overview

```mermaid
sequenceDiagram
    participant G as Generator
    participant P as Perplexity Sonar
    participant N as Gemini Flash
    participant R as Result

    G->>P: ì¢…ëª©ëª… ì „ë‹¬
    P->>P: ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ (24h í•„í„°)
    P-->>G: ë‰´ìŠ¤ ìš”ì•½ + Citations

    G->>N: Perplexity ê²°ê³¼ + ë„¤ì´ë²„ ë‰´ìŠ¤
    N->>N: ì¢…í•© ë¶„ì„ (í˜¸ì¬ ì ìˆ˜ + í…Œë§ˆ ì¶”ì¶œ)
    N-->>G: JSON {score, reason, themes}

    G->>R: ìµœì¢… ê²°ê³¼ ë°˜í™˜
```

---

## ğŸ”· 1. Perplexity Client (ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰)

### í´ë˜ìŠ¤ ì •ë³´

| í•­ëª© | ê°’ |
|------|-----|
| **í´ë˜ìŠ¤ëª…** | `PerplexityClient` |
| **API URL** | `https://api.perplexity.ai/chat/completions` |
| **ëª¨ë¸** | `sonar` (ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ íŠ¹í™”) |
| **í™˜ê²½ë³€ìˆ˜** | `PERPLEXITY_API_KEY` |

### í•µì‹¬ ë©”ì„œë“œ: `search_stock_news()`

```python
async def search_stock_news(self, stock_name: str, stock_code: str = "") -> Dict:
    """
    Returns:
        {
            "news_summary": "ë‰´ìŠ¤ ìš”ì•½ í…ìŠ¤íŠ¸",
            "citations": ["https://...", ...],  # ì¶œì²˜ URL ë¦¬ìŠ¤íŠ¸
            "raw_response": "..."
        }
    """
```

### API ìš”ì²­ êµ¬ì„±

```python
payload = {
    "model": "sonar",                      # ì‹¤ì‹œê°„ ê²€ìƒ‰ ëª¨ë¸
    "messages": [
        {"role": "system", "content": "í•œêµ­ ì£¼ì‹ ì‹œì¥ ì „ë¬¸ ë¦¬ì„œì¹˜ ì• ë„ë¦¬ìŠ¤íŠ¸..."},
        {"role": "user", "content": query}
    ],
    "temperature": 0.2,                    # ë‚®ì€ ì°½ì˜ì„± (ì‚¬ì‹¤ ê¸°ë°˜)
    "max_tokens": 1024,
    "return_citations": True,              # ì¶œì²˜ URL ë°˜í™˜
    "search_recency_filter": "day"         # ìµœê·¼ 24ì‹œê°„ ê²°ê³¼ ìš°ì„ 
}
```

### ê²€ìƒ‰ ì¿¼ë¦¬ í…œí”Œë¦¿

```
"{ì¢…ëª©ëª…}" ì¢…ëª©ì— ëŒ€í•œ ìµœì‹  ë‰´ìŠ¤ì™€ ì‹œì¥ ë™í–¥ì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ì„œ ë‹µë³€í•´ì£¼ì„¸ìš”:
1. ìµœê·¼ 24ì‹œê°„ ì´ë‚´ì˜ ì£¼ìš” ë‰´ìŠ¤ (í˜¸ì¬/ì•…ì¬)
2. ì‹¤ì  ê´€ë ¨ ì •ë³´ (ìˆëŠ” ê²½ìš°)
3. ìˆ˜ì£¼/ê³„ì•½ ê´€ë ¨ ì •ë³´ (ìˆëŠ” ê²½ìš°)
4. ê´€ë ¨ í…Œë§ˆë‚˜ ì‚°ì—… ë™í–¥
5. ê¸°ê´€/ì™¸êµ­ì¸ ìˆ˜ê¸‰ ë™í–¥ (ìˆëŠ” ê²½ìš°)
```

---

## ğŸ”¶ 2. Gemini Analyzer (ë‰´ìŠ¤ ë¶„ì„ + ì ìˆ˜í™”)

### í´ë˜ìŠ¤ ì •ë³´

| í•­ëª© | ê°’ |
|------|-----|
| **í´ë˜ìŠ¤ëª…** | `GeminiAnalyzer` |
| **ëª¨ë¸** | `gemini-3-pro-preview` (í™˜ê²½ë³€ìˆ˜ë¡œ ë³€ê²½ ê°€ëŠ¥) |
| **í™˜ê²½ë³€ìˆ˜** | `GOOGLE_API_KEY`, `GEMINI_MODEL` |
| **íƒ€ì„ì•„ì›ƒ** | 30ì´ˆ |

### í•µì‹¬ ë©”ì„œë“œ: `analyze_news()`

```python
async def analyze_news(
    self, 
    stock_name: str, 
    news_content: str,           # Perplexity ê²°ê³¼
    traditional_news: List[Dict] = None  # ë„¤ì´ë²„ ë‰´ìŠ¤ (ë°±ì—…)
) -> Dict:
    """
    Returns:
        {"score": 2, "reason": "ë¶„ì„ ì´ìœ ", "themes": ["AI", "ë°˜ë„ì²´"]}
    """
```

### í˜¸ì¬ ì ìˆ˜ ê¸°ì¤€ (0~3ì )

| ì ìˆ˜ | ì¡°ê±´ | ì˜ˆì‹œ |
|------|------|------|
| **3ì ** | í™•ì‹¤í•œ í˜¸ì¬ | ëŒ€ê·œëª¨ ìˆ˜ì£¼, ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ, ì‹ ì•½ ìŠ¹ì¸, M&A |
| **2ì ** | ê¸ì •ì  í˜¸ì¬ | ì‹¤ì  ê°œì„ , ì‹ ì‚¬ì—… ê¸°ëŒ€ê°, í…Œë§ˆ ìƒìŠ¹ ëª¨ë©˜í…€ |
| **1ì ** | ë‹¨ìˆœ/ì¤‘ë¦½ | ì¼ë°˜ ë‰´ìŠ¤, í° ì˜í–¥ ì—†ìŒ |
| **0ì ** | ì•…ì¬ ë˜ëŠ” ë¬´ì†Œì‹ | ë¶€ì •ì  ë‰´ìŠ¤, í˜¸ì¬ ì—†ìŒ |

### í…Œë§ˆ ì¶”ì¶œ ì˜ˆì‹œ

```
ë¡œë´‡, AIë°˜ë„ì²´, 2ì°¨ì „ì§€, ë°©ì‚°, ìš°ì£¼í•­ê³µ, ë°”ì´ì˜¤, 
ê·¸ë£¹ì¬í¸, M&A, HBM, ì „ë ¥ë°˜ë„ì²´, íƒœì–‘ê´‘ ...
```

### í”„ë¡¬í”„íŠ¸ êµ¬ì¡°

```
ë‹¹ì‹ ì€ ì£¼ì‹ íˆ¬ì ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ '{ì¢…ëª©ëª…}' ì¢…ëª©ì— ëŒ€í•œ ë‰´ìŠ¤ ë° ì •ë³´ì…ë‹ˆë‹¤.

[Perplexity ì‹¤ì‹œê°„ ê²€ìƒ‰ ê²°ê³¼]
{news_content}

[ë„¤ì´ë²„ ê¸ˆìœµ ë‰´ìŠ¤]
{traditional_text}

ìœ„ ì •ë³´ë¥¼ **ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„**í•˜ì—¬:
1. í˜„ì¬ ì‹œì ì—ì„œì˜ í˜¸ì¬ ê°•ë„ë¥¼ 0~3ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”.
2. í•µì‹¬ íˆ¬ì í…Œë§ˆë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (1~3ê°œ)

[ì¶œë ¥ í˜•ì‹]
{"score": 2, "reason": "ì¢…í•© í‰ê°€ ì´ìœ  í•œ ì¤„", "themes": ["í…Œë§ˆ1", "í…Œë§ˆ2"]}
```

---

## ğŸ”— 3. í†µí•© LLM Analyzer

### í´ë˜ìŠ¤ ì •ë³´

| í•­ëª© | ê°’ |
|------|-----|
| **í´ë˜ìŠ¤ëª…** | `LLMAnalyzer` |
| **ì—­í• ** | Perplexity + Gemini í†µí•© ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° |

### í•µì‹¬ ë©”ì„œë“œ: `analyze_news_sentiment()`

```python
async def analyze_news_sentiment(
    self, 
    stock_name: str, 
    news_items: List[Dict]  # ë„¤ì´ë²„ ë‰´ìŠ¤ (ë°±ì—…ìš©)
) -> Dict:
    """
    Returns:
        {
            "score": 2,              # 0~3 í˜¸ì¬ ì ìˆ˜
            "reason": "...",         # ë¶„ì„ ì´ìœ 
            "themes": [...],         # ì¶”ì¶œëœ í…Œë§ˆ
            "citations": [...],      # Perplexity ì¶œì²˜ URL
            "source": "perplexity+gemini"
        }
    """
```

### ì²˜ë¦¬ íë¦„

```
1. Perplexity Sonarë¡œ ì‹¤ì‹œê°„ ë‰´ìŠ¤ ê²€ìƒ‰
   â†“
2. Rate Limit ë°©ì§€ (2ì´ˆ ëŒ€ê¸°)
   â†“
3. Geminië¡œ ë‰´ìŠ¤ ë¶„ì„ (Perplexity + ë„¤ì´ë²„ ë‰´ìŠ¤ í†µí•©)
   â†“
4. ê²°ê³¼ ë°˜í™˜ {score, reason, themes, citations, source}
```

### Source í•„ë“œ ê°’

| ê°’ | ì˜ë¯¸ |
|----|------|
| `perplexity+gemini` | ì •ìƒ ì²˜ë¦¬ (ë‘˜ ë‹¤ ì‚¬ìš©) |
| `gemini_only` | Perplexity ê²°ê³¼ ì—†ìŒ, Geminië§Œ ì‚¬ìš© |
| `keyword_fallback` | Gemini ì—†ìŒ, í‚¤ì›Œë“œ ë¶„ì„ í´ë°± |
| `none` | ë¶„ì„ ì‹¤íŒ¨ |

---

## ğŸ›¡ï¸ 4. í´ë°± ë¡œì§ (Fallback)

Gemini ì—†ì„ ë•Œ í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ìˆ˜í–‰:

### ê¸ì • í‚¤ì›Œë“œ (+1ì ì”©, ìµœëŒ€ 3ì )

```python
positive_keywords = [
    "í‘ìì „í™˜", "ì‹¤ì ê°œì„ ", "ì–´ë‹ì„œí”„ë¼ì´ì¦ˆ", "ì‚¬ìƒìµœëŒ€", "í˜¸ì‹¤ì ",
    "ìˆ˜ì£¼", "ê³„ì•½ì²´ê²°", "ê³µê¸‰ê³„ì•½", "MOU", "ì‹ ì•½", "ì„ìƒì„±ê³µ",
    "FDAìŠ¹ì¸", "íŠ¹í—ˆ", "ê¸°ìˆ ì´ì „", "ì™¸êµ­ì¸ë§¤ìˆ˜", "ê¸°ê´€ë§¤ìˆ˜"
]
```

### ë¶€ì • í‚¤ì›Œë“œ (ì¦‰ì‹œ 0ì )

```python
negative_keywords = [
    "íš¡ë ¹", "ë°°ì„", "ìƒì¥íì§€", "ê´€ë¦¬ì¢…ëª©", "ì ìì „í™˜", "ì ìí™•ëŒ€",
    "ê²€ì°°", "ìˆ˜ì‚¬", "ê¸°ì†Œ", "ëŒ€ëŸ‰ë§¤ë„"
]
```

---

## âš™ï¸ 5. í™˜ê²½ ì„¤ì •

### í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ (.env)

```bash
# Perplexity API (ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰)
PERPLEXITY_API_KEY=pplx-xxxxxxxxxxxxxxxx

# Google Gemini API (ë‰´ìŠ¤ ë¶„ì„)
GOOGLE_API_KEY=AIzaxxxxxxxxxxxxxxxx
GEMINI_MODEL=gemini-2.0-flash-exp  # Optional (ê¸°ë³¸ê°’)
```

---

## ğŸ§ª 6. í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```python
# ë‹¨ë… ì‹¤í–‰ í…ŒìŠ¤íŠ¸
python kr_market/engine/llm_analyzer.py
```

### ì˜ˆìƒ ì¶œë ¥

```json
{
  "score": 2,
  "reason": "HBM3E ì–‘ì‚° ì‹œì‘ìœ¼ë¡œ AI ë°˜ë„ì²´ ìˆ˜ìš” ëŒ€ì‘ ê¸°ëŒ€",
  "themes": ["HBM", "AIë°˜ë„ì²´"],
  "citations": ["https://news.example.com/..."],
  "source": "perplexity+gemini"
}
```

---

## ğŸ“ˆ 7. ì „ì²´ ìŠ¤ì½”ì–´ë§ì—ì„œì˜ ìœ„ì¹˜

ì¢…ê°€ë² íŒ… V2 ì´ì  **12ì ** ì¤‘ **ë‰´ìŠ¤ ë¶„ì„ ì ìˆ˜ëŠ” 3ì  (25%)**:

| êµ¬ì„± ìš”ì†Œ | ë°°ì  |
|-----------|------|
| MA ì •ë°°ì—´ | 2ì  |
| ê±°ë˜ëŸ‰ | 3ì  |
| ìº”ë“¤ íŒ¨í„´ | 2ì  |
| ê°€ê²© ìœ„ì¹˜ | 2ì  |
| **ë‰´ìŠ¤ ë¶„ì„ (LLM)** | **3ì ** |
| íš¡ë³´ ëŒíŒŒ | +bonus |

---

> **ì°¸ê³ **: ì´ ë¬¸ì„œëŠ” `kr_market/engine/llm_analyzer.py` ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
